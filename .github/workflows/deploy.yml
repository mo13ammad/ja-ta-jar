name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Notify Server for Deployment
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}  # ØªÙˆÚ©Ù† Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ø®ØµÛŒ
        run: |
          # Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ SSH Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p 9011 $SERVER_USER@$SERVER_IP "echo 'SSH connection successful'"
          # Ø§Ú¯Ø± Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p 9011 $SERVER_USER@$SERVER_IP << 'EOF'
            echo terminalok
            cd jatajar-front
            echo "Entering folder"
            git stash
            echo stashok
            #git fetch https://x-access-token:${{ secrets.TOKEN }}@github.com/mo13ammad/jatajar-front.git
            git pull https://x-access-token:${{ secrets.TOKEN }}@github.com/mo13ammad/jatajar-front.git
            #git reset --hard origin/main
            echo "Git reset to main branch"
            npm install build
            npm run build
            # Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§Ø¶Ø§ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆØ±
            # Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø«Ø§Ù„:
            # systemctl restart your_service
          EOF
   #  - name: Send SMS Notification
     #   env:
     #     MOBILE: ${{ secrets.MOBILE }}
      #    SMSIRAPI: ${{ secrets.SMSIRAPI }}
        #  SMSIRLINENUMBER: ${{ secrets.SMSIRLINENUMBER }}
       #   SMSIRUSERNAME: ${{ secrets.SMSIRUSERNAME }}
        #  COMMIT_MESSAGE: ${{ github.event.head_commit.message }}  # Ù¾ÛŒØ§Ù… Ú©Ø§Ù…ÛŒØª
      #  run: |
       #   MESSAGE="Ø¨Ø±Ù†Ú† Ø§ØµÙ„ÛŒ ÙØ±Ø§Ù†Øª Ø¬Ø§Øª Ø¢Ø¬Ø§Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú©Ø§Ù…ÛŒØª '${COMMIT_MESSAGE}' Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯"
     #     MESSAGE_ENCODED=$(echo "$MESSAGE" | jq -sRr @uri)  # URL encode
      #    curl -X GET "https://api.sms.ir/v1/send?username=$SMSIRUSERNAME&password=$SMSIRAPI&line=$SMSIRLINENUMBER&mobile=$MOBILE&text=$MESSAGE_ENCODED"
          
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}  # Ù¾ÛŒØ§Ù… Ú©Ø§Ù…ÛŒØª
          AUTHOR_NAME: ${{ github.event.head_commit.author.name }}  # Ù†Ø§Ù… Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡
          REPO_URL: "https://github.com/${{ github.repository }}"
          COMMIT_URL: "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

        run: |
          MESSAGE="âœ… <b>Ø¨Ø±Ù†Ú† Ø§ØµÙ„ÛŒ ÙØ±Ø§Ù†Øª Ø¬Ø§Øª Ø¢Ø¬Ø§Ø± Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯!</b> ğŸ“ <b>Ú©Ø§Ù…ÛŒØª:</b> <code>${COMMIT_MESSAGE}</code> ğŸ‘¤ <b>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡:</b> ${AUTHOR_NAME} ğŸ”— <a href=\"${REPO_URL}\">Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ù…Ø®Ø²Ù†</a> ğŸ”— <a href=\"${COMMIT_URL}\">Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ú©Ø§Ù…ÛŒØª</a>"

          curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID&text=$MESSAGE" -d "parse_mode=HTML"
