
name: Deploy and Notify via Telegram

on:
  push:
    branches:
      - '**'

jobs:
  deploy-and-notify:
    runs-on: ubuntu-latest

    steps:
      # Ù…Ø±Ø­Ù„Ù‡ 1: Ú©Ù„ÙˆÙ† Ú©Ø±Ø¯Ù† Ú©Ø¯ Ù…Ø®Ø²Ù†
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Ù…Ø±Ø­Ù„Ù‡ 2: Ù†ØµØ¨ sshpass Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      # Ù…Ø±Ø­Ù„Ù‡ 3: Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙ‚Ø±Ø§Ø±
      - name: Deploy to Server (Main Branch Only)
        if: github.ref_name == 'main'  # Ø´Ø±Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ ÙÙ‚Ø· Ø±ÙˆÛŒ Ø¨Ø±Ù†Ú† main
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ SSH Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p 9011 $SERVER_USER@$SERVER_IP "echo 'SSH connection successful'"
          # Ø§Ú¯Ø± Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯
          sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p 9011 $SERVER_USER@$SERVER_IP << 'EOF'
            echo terminalok
            cd jatajar-front
            echo "Entering folder"
            git stash
            echo stashok
            #git fetch https://x-access-token:${{ secrets.TOKEN }}@github.com/mo13ammad/jatajar-front.git
            git pull https://x-access-token:${{ secrets.TOKEN }}@github.com/mo13ammad/jatajar-front.git --rebase
            #git reset --hard origin/main
            echo "Git reset to main branch"
            npm install build
            npm run build
            # Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§Ø¶Ø§ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆØ±
            # Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø«Ø§Ù„:
            # systemctl restart your_service
          EOF
      # Ù…Ø±Ø­Ù„Ù‡ 4: ØªÙ†Ø¸ÛŒÙ… Ù…Ø­ÛŒØ· Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.13.0  # Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒâ€ŒØ´Ø¯Ù‡

      # Ù…Ø±Ø­Ù„Ù‡ 5: Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
      - name: Install Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install python-telegram-bot==20.3
      # Ù…Ø±Ø­Ù„Ù‡ 6: Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… ØªÙ„Ú¯Ø±Ø§Ù…
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          AUTHOR_NAME: ${{ github.event.head_commit.author.name }}
          REPO_URL: "https://github.com/${{ github.repository }}"
          COMMIT_URL: "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          BRANCH_NAME: ${{ github.ref_name }}
          PUSH_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        run: |
          python3 - <<'EOF'
          import os
          import asyncio
          from telegram import Bot
          from telegram.constants import ParseMode
          
          async def send_message():
              # Ø¯Ø±ÛŒØ§ÙØª Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
              bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
              chat_id = os.getenv("TELEGRAM_CHAT_ID")
              commit_message = os.getenv("COMMIT_MESSAGE")
              author_name = os.getenv("AUTHOR_NAME")
              repo_url = os.getenv("REPO_URL")
              commit_url = os.getenv("COMMIT_URL")
              branch_name = os.getenv("BRANCH_NAME")
              push_timestamp = os.getenv("PUSH_TIMESTAMP")
              
              # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ§Ù…
              message = (
                  "ğŸ“¢ <b>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!</b>\n\n"
                  "ğŸ”– <b>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:</b>\n"
                  f"ğŸ“‚ <b>Ø¨Ø±Ù†Ú†:</b> <code>{branch_name}</code>\n"
                  f"ğŸ“ <b>ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù…ÛŒØª:</b> <code>{commit_message}</code>\n"
                  f"ğŸ‘¤ <b>Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡:</b> {author_name}\n"
                  f"â° <b>Ø²Ù…Ø§Ù†:</b> {push_timestamp}\n\n"
                  "ğŸ”— <b>Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§:</b>\n"
                  f"ğŸ“ <a href=\"{repo_url}\">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø®Ø²Ù†</a>\n"
                  f"ğŸ”— <a href=\"{commit_url}\">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø§Ù…ÛŒØª</a>\n\n"
                  "Ø¨Ø§ Ø§Ø­ØªØ±Ø§Ù…ØŒ\n"
                  "\n\n"
                  "ğŸŒ <a href=\"https://viraup.com\">ÙˆÛŒÙ€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ø±Ø§Ù¾</a>\n"
              )
              
              # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Bot
              bot = Bot(token=bot_token)
              await bot.send_message(chat_id=chat_id, text=message, parse_mode=ParseMode.HTML)
              print("Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")
          
          asyncio.run(send_message())
          EOF
